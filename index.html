<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>배차 경로 안내</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        .container-fluid, .map-container, #map {
            height: 100vh;
            min-height: 100%;
        }
        .address-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .custom-overlay {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            width: 300px;
        }
        .map-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container-fluid p-0">
        <div class="map-container">
            <div id="map"></div>
            <div class="custom-overlay">
                <div class="card">
                    <div class="card-header">
                        <h5>거래처 선택</h5>
                        <select id="companySelect" class="form-select mb-3">
                            <option value="">거래처를 선택하세요</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6>출발지 선택</h6>
                            <select id="startAddress" class="form-select">
                                <option value="">출발지를 선택하세요</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <h6>도착지 선택</h6>
                            <select id="endAddress" class="form-select">
                                <option value="">도착지를 선택하세요</option>
                            </select>
                        </div>
                        <button id="searchRoute" class="btn btn-primary w-100">경로 검색</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=595943c74a4a4d916c65d147ac95e009&libraries=services"></script>
    <script>
        // 카카오맵 초기화
        var mapContainer = document.getElementById('map');
        var mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.978656), // 서울시청 좌표
            level: 3
        };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        var directionsService = new kakao.maps.services.Directions();
        var directionsRenderer = new kakao.maps.DirectionsRenderer({
            map: map
        });

        // 구글 시트 CSV URL
        const SHEET_ID = "1CrKQ-Baj4rnL8eYuehLLBuFS9Orsm5qlicd9Nq-kxjU";
        const SHEET_NAME = "주소";
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

        // 거래처 데이터 저장용
        let companies = {};

        // 구글 시트에서 데이터 불러오기
        fetch(SHEET_URL)
            .then(response => response.text())
            .then(csvText => {
                console.log(csvText);
                const rows = csvText.trim().split('\n').map(row => row.split(','));
                // 첫 행은 컬럼명이므로 제외
                rows.slice(1).forEach(cols => {
                    const company = cols[0].trim();
                    const name = cols[1].trim();
                    const address = cols[2].trim();
                    if (!companies[company]) companies[company] = [];
                    companies[company].push({ name, address });
                });
                updateCompanySelect();
            });

        // 거래처 선택 옵션 생성
        function updateCompanySelect() {
            const companySelect = document.getElementById('companySelect');
            companySelect.innerHTML = '<option value="">거래처를 선택하세요</option>';
            Object.keys(companies).forEach(company => {
                const option = document.createElement('option');
                option.value = company;
                option.textContent = company;
                companySelect.appendChild(option);
            });
        }

        // 거래처 선택 시 출발지/도착지 목록 업데이트
        document.getElementById('companySelect').addEventListener('change', function() {
            const selectedCompany = this.value;
            const startAddress = document.getElementById('startAddress');
            const endAddress = document.getElementById('endAddress');
            startAddress.innerHTML = '<option value="">출발지를 선택하세요</option>';
            endAddress.innerHTML = '<option value="">도착지를 선택하세요</option>';

            if (selectedCompany && companies[selectedCompany]) {
                companies[selectedCompany].forEach(location => {
                    const startOption = document.createElement('option');
                    startOption.value = location.name;
                    startOption.textContent = location.name;
                    startAddress.appendChild(startOption);

                    const endOption = document.createElement('option');
                    endOption.value = location.address;
                    endOption.textContent = location.address;
                    endAddress.appendChild(endOption);
                });
            }
        });

        // 경로 검색
        document.getElementById('searchRoute').addEventListener('click', function() {
            const selectedCompany = document.getElementById('companySelect').value;
            const startName = document.getElementById('startAddress').value;
            const endAddress = document.getElementById('endAddress').value;

            if (!selectedCompany || !startName || !endAddress) {
                alert('거래처, 출발지, 도착지를 모두 선택해주세요.');
                return;
            }

            // 출발지 이름에 해당하는 주소 찾기
            const startObj = companies[selectedCompany].find(loc => loc.name === startName);
            if (!startObj) {
                alert('출발지 정보를 찾을 수 없습니다.');
                return;
            }
            const startAddress = startObj.address;

            // 주소를 좌표로 변환
            const geocoder = new kakao.maps.services.Geocoder();
            geocoder.addressSearch(startAddress, function(result, status) {
                if (status === kakao.maps.services.Status.OK) {
                    const startCoords = new kakao.maps.LatLng(result[0].y, result[0].x);

                    geocoder.addressSearch(endAddress, function(result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const endCoords = new kakao.maps.LatLng(result[0].y, result[0].x);

                            // 경로 검색
                            directionsService.route({
                                origin: startCoords,
                                destination: endCoords,
                                waypoints: [],
                                priority: kakao.maps.RoutePriority.FASTEST
                            }, function(result, status) {
                                if (status === kakao.maps.services.Status.OK) {
                                    directionsRenderer.setDirections(result);
                                } else {
                                    alert('경로를 찾을 수 없습니다.');
                                }
                            });
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>
